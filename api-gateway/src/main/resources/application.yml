server:
  port: 8070                        # Gateway listens here (clients call localhost:8070)

spring:
  application:
    name: api-gateway

  cloud:
    gateway:
      routes:
        - id: user-service
          uri: http://localhost:8081          # Internal port of User Service
          predicates:
            - Path=/api/users/**
          filters:
            - RewritePath=/api/users/(?<segment>.*), /${segment}
            - TokenRelay

        - id: training-service
          uri: http://localhost:8082
          predicates:
            - Path=/api/formations/**, /api/courses/**, /api/enrollments/**
          filters:
            - RewritePath=/api/(?<segment>.*), /${segment}
            - TokenRelay

        - id: session-service
          uri: http://localhost:8083
          predicates:
            - Path=/api/sessions/**, /api/attendance/**
          filters:
            - RewritePath=/api/(?<segment>.*), /${segment}
            - TokenRelay

        - id: video-session-service
          uri: http://localhost:8084
          predicates:
            - Path=/api/video-sessions/**
          filters:
            - RewritePath=/api/video-sessions/(?<segment>.*), /${segment}
            - TokenRelay

        - id: exam-service
          uri: http://localhost:8085
          predicates:
            - Path=/api/exams/**, /api/certificates/**
          filters:
            - RewritePath=/api/(?<segment>.*), /${segment}
            - TokenRelay

        - id: document-service
          uri: http://localhost:8086
          predicates:
            - Path=/api/documents/**
          filters:
            - RewritePath=/api/documents/(?<segment>.*), /${segment}
            - TokenRelay

        - id: payment-service
          uri: http://localhost:8087
          predicates:
            - Path=/api/payments/**
          filters:
            - RewritePath=/api/payments/(?<segment>.*), /${segment}
            - TokenRelay

        - id: notification-service
          uri: http://localhost:8088
          predicates:
            - Path=/api/notifications/**
          filters:
            - RewritePath=/api/notifications/(?<segment>.*), /${segment}
            - TokenRelay

        - id: analytics-service
          uri: http://localhost:8089
          predicates:
            - Path=/api/analytics/**
          filters:
            - RewritePath=/api/analytics/(?<segment>.*), /${segment}
            - TokenRelay

        - id: ai-service
          uri: http://localhost:8090
          predicates:
            - Path=/api/ai/**
          filters:
            - RewritePath=/api/ai/(?<segment>.*), /${segment}
            - TokenRelay

      globalcors:
        cors-configurations:
          '[/**]':
            allowedOrigins: ["http://localhost:3000"]   # Your Next.js frontend
            allowedMethods: ["*"]
            allowedHeaders: ["*"]
            allowCredentials: true

  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://localhost:8080/realms/training-platform-realm   # Keycloak port (8080)

management:
  endpoints:
    web:
      exposure:
        include: "*"

resilience4j:
  ratelimiter:
    instances:
      default:
        limitForPeriod: 100
        limitRefreshPeriod: 1s

logging:
  level:
    org.springframework.cloud.gateway: DEBUG